# 功能规划：日志系统重构与 Bitwarden 客户端全局锁

**规划时间**：2026-01-10
**预估工作量**：6 任务点

---

## 1. 功能概述

### 1.1 目标

1. **模块级 Logger**：创建预定义模块 logger，自动携带 module 字段
2. **文本格式输出**：将 JSON 格式改为单行文本格式
3. **Bitwarden 全局锁**：添加 mutex 防止并发调用 CLI

### 1.2 涉及模块

| 模块 | 文件 | 修改类型 |
|------|------|---------|
| logger | `internal/logger/logger.go` | 核心重构 |
| crypto | `internal/crypto/crypto.go` | 调用更新 |
| scheduler | `internal/scheduler/*.go` | 调用更新 |
| bitwarden | `internal/bitwarden/client.go` | 调用更新 + 全局锁 |
| main | `cmd/server/main.go` | 调用更新 |
| database | `internal/database/*.go` | 调用更新 |

---

## 2. 任务分解

### 任务 1：重构 logger 包（核心）

**文件**: `internal/logger/logger.go`

**修改内容**:

1. 将 `JSONHandler` 改为 `TextHandler`
2. 添加模块常量定义
3. 添加 `Module(name)` 函数
4. 添加模块级便捷方法

**代码示例**:

```go
// 模块常量
const (
    ModuleMain       = "main"
    ModuleEncryption = "encryption"
    ModuleScheduler  = "scheduler"
    ModuleBitwarden  = "bitwarden"
    ModuleDatabase   = "database"
)

// Module 返回带模块标识的 logger
func Module(name string) *slog.Logger {
    return Get().With("module", name)
}
```

---

### 任务 2：更新 crypto 模块日志

**文件**: `internal/crypto/crypto.go`

**修改点**: 8 处日志调用

**修改方式**:
```go
// 修改前
logger.Info("Master key loaded from environment variable", "module", "encryption")

// 修改后
logger.Module(logger.ModuleEncryption).Info("Master key loaded from environment variable")
```

---

### 任务 3：更新 scheduler 模块日志

**文件**:
- `internal/scheduler/scheduler.go`
- `internal/scheduler/execute.go`
- `internal/scheduler/execute_now.go`
- `internal/scheduler/task.go`
- `internal/scheduler/destination_handler.go`
- `internal/scheduler/multi_destination.go`

**修改点**: 14 处日志调用

---

### 任务 4：更新 bitwarden 模块日志 + 添加全局锁

**文件**: `internal/bitwarden/client.go`

**修改内容**:

1. 添加包级 mutex
2. 在 `runBW` 方法中加锁
3. 更新日志调用使用模块 logger

**代码示例**:
```go
var bwMu sync.Mutex

func (c *Client) runBW(ctx context.Context, args []string, stdin string, extraEnv map[string]string) (bwExecResult, error) {
    bwMu.Lock()
    defer bwMu.Unlock()
    // ... 原有逻辑
}
```

---

### 任务 5：更新 main 和 database 模块日志

**文件**:
- `cmd/server/main.go` (3 处)
- `internal/database/db.go` (1 处)
- `internal/database/migrate.go` (6 处)

---

### 任务 6：验证与测试

1. 编译验证：`go build ./...`
2. 运行验证：启动服务器检查日志格式
3. 并发验证：同时触发多个备份任务

---

## 3. 实施顺序

```
任务 1 (logger 核心)
    ↓
任务 2-5 (各模块更新，可并行)
    ↓
任务 6 (验证)
```

---

## 4. 验收标准

- [ ] 日志输出为单行文本格式
- [ ] 所有日志自动携带 module 字段
- [ ] 无手动 `"module", "xxx"` 键值对
- [ ] Bitwarden CLI 调用串行执行
- [ ] `go build ./...` 编译通过
