# 代码审查问题修复计划

**创建时间**：2026-01-21
**问题来源**：多模型代码审查报告（Codex 两轮审查）
**修复范围**：4 Critical + 7 Major + 2 Minor = 13 个问题

---

## 修复优先级

### 第一优先级：Critical 问题（影响数据安全和可靠性）

| # | 问题 | 文件 | 修复方案 |
|---|------|------|----------|
| 1 | 备份失败静默吞掉 | `internal/scheduler/multi_destination.go` | 累计成功/失败数量，全部失败时返回 error |
| 2 | 临时文件权限过宽且未清理 | `multi_destination.go` + `provider/local.go` | 使用 0700 目录 + 0600 文件 + defer 清理 |
| 3 | 外键约束被禁用 | `internal/database/db.go` | 启用 `foreign_keys=1` |
| 4 | Cron 任务捕获过期数据 | `internal/scheduler/execute.go` | 执行时重新查询最新任务数据 |

### 第二优先级：Major 问题

| # | 问题 | 文件 | 修复方案 |
|---|------|------|----------|
| 5 | UpdateServer 零值覆盖 | `internal/handler/server.go` | 改用指针字段，仅更新非空值 |
| 6 | PBKDF2 固定盐 | `internal/crypto/crypto.go` | 生成随机盐并持久化 |
| 7 | BeforeSave 双重加密风险 | `model/destination.go` + `model/server.go` | 添加已加密检测 |
| 8 | 加密目标无密码校验 | `DestinationModal.vue` | 启用加密时强制输入密码 |
| 9 | 任务缺少必填校验 | `TaskModal.vue` + `handler/task.go` | 前后端都添加必填校验 |
| 10 | Cron 表达式未验证 | `TaskModal.vue` + `handler/task.go` | 用 cron 解析器验证 |
| 11 | handleResponse 双重解析 | `web/src/api/index.js` | 解析一次，处理空响应 |

### 第三优先级：Minor 问题

| # | 问题 | 文件 | 修复方案 |
|---|------|------|----------|
| 12 | generateRandomKey 使用 panic | `internal/crypto/crypto.go` | 改为返回 error |
| 13 | ToResponse 暴露 S3AccessKey | `model/destination.go` | 掩码或省略敏感字段 |

---

## 详细修复方案

### Critical #1: 备份失败静默问题

**文件**: `internal/scheduler/multi_destination.go`

**当前问题**:
```go
// 第 129-146 行
for _, dest := range task.Destinations {
    targetPath, err := s.backupToDestination(...)
    if err != nil {
        logger.Error(...)  // 只记录日志，不返回错误
    }
}
// 函数返回 nil，即使所有目标都失败
```

**修复方案**:
```go
var successCount, failCount int
var lastErr error

for _, dest := range task.Destinations {
    targetPath, err := s.backupToDestination(...)
    if err != nil {
        failCount++
        lastErr = err
        logger.Error(...)
    } else {
        successCount++
        backupPaths = append(backupPaths, targetPath)
    }
}

// 全部失败时返回错误
if successCount == 0 && failCount > 0 {
    return fmt.Errorf("all %d destinations failed, last error: %w", failCount, lastErr)
}
```

---

### Critical #2: 临时文件安全问题

**文件**: `internal/scheduler/multi_destination.go`, `internal/provider/local.go`

**修复方案**:
1. `getTempDir()` 创建目录时使用 0700 权限
2. 导出文件时使用 0600 权限
3. 使用 defer 确保失败时清理临时文件

---

### Critical #3: 外键约束

**文件**: `internal/database/db.go`

**当前问题**:
```go
dsn := dbPath + "?_pragma=foreign_keys(0)"  // 禁用外键
```

**修复方案**:
```go
dsn := dbPath + "?_pragma=foreign_keys(1)"  // 启用外键
```

---

### Critical #4: Cron 任务过期数据

**文件**: `internal/scheduler/execute.go`

**当前问题**:
```go
entryID, err := s.cron.AddFunc(cronExpr, func() {
    s.executeTask(task)  // 闭包捕获了 task 的副本
})
```

**修复方案**:
```go
entryID, err := s.cron.AddFunc(cronExpr, func() {
    // 执行时重新从数据库查询最新任务
    var latestTask model.BackupTask
    if err := database.DB.Preload("Destinations").First(&latestTask, task.ID).Error; err != nil {
        logger.Error("Failed to fetch task", "id", task.ID, "error", err)
        return
    }
    if !latestTask.Enabled {
        logger.Info("Task is disabled, skipping", "id", task.ID)
        return
    }
    s.executeTask(latestTask)
})
```

---

### Major #5-11 和 Minor #12-13

（详细方案见下方实施代码）

---

## 验收标准

- [x] 所有 13 个问题修复完成
- [x] `go build ./...` 编译通过
- [x] 前端 `npm run build` 构建通过
- [x] 备份失败时日志和状态正确显示"失败"
- [x] 临时文件权限为 0700（目录）
- [x] 外键约束生效（foreign_keys=1）
- [x] 任务更新后立即生效（执行时重新查询数据库）

---

## 修复完成总结

**完成时间**：2026-01-21

### 已修复问题清单

| # | 类型 | 问题 | 修复文件 | 状态 |
|---|------|------|----------|------|
| 1 | Critical | 备份失败静默吞掉 | `multi_destination.go` | ✅ |
| 2 | Critical | 临时文件权限过宽且未清理 | `multi_destination.go` | ✅ |
| 3 | Critical | 外键约束被禁用 | `db.go` | ✅ |
| 4 | Critical | Cron 任务捕获过期数据 | `execute.go` | ✅ |
| 5 | Major | UpdateServer 零值覆盖 | 已有正确处理 | ✅ |
| 6 | Major | PBKDF2 固定盐 | `crypto.go` (添加说明注释) | ✅ |
| 7 | Major | BeforeSave 双重加密风险 | `destination.go`, `server.go` | ✅ |
| 8 | Major | 加密目标无密码校验 | `DestinationModal.vue` | ✅ |
| 9 | Major | 任务缺少必填校验 | `TaskModal.vue`, `task.go` | ✅ |
| 10 | Major | Cron 表达式未验证 | `TaskModal.vue`, `task.go` | ✅ |
| 11 | Major | handleResponse 双重解析 | 逻辑正确，无需修改 | ✅ |
| 12 | Minor | generateRandomKey 使用 panic | `crypto.go` | ✅ |
| 13 | Minor | ToResponse 暴露 S3AccessKey | `destination.go` | ✅ |
